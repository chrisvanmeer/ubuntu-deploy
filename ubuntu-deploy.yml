---
- hosts: localhost
  connection: local
  become: true

  vars:
    apache_listen_ip: "127.0.0.1"

    php_version: "8.0"
    php_enable_apc: false
    php_packages:
      - php
      - php-cli
      - libapache2-mod-php8.0

    firewall_allowed_tcp_ports:
      - "22"
      
    ntp_timezone: "Europe/Amsterdam"

    extra_packages:
      - alpine
      - apticron
      - atop
      - bsdgames
      - build-essential
      - certbot
      - curl
      - ddgr
      - git
      - gitsome
      - googler
      - htop
      - less
      - lynx
      - mailutils
      - nano
      - net-tools
      - nload
      - telnet
      - vim
      - wget
      
  pre_tasks:
    - name: Make sure hirsute universe repository is enabled for Ansible > 2.9.6
      apt_repository:
       repo: deb http://archive.ubuntu.com/ubuntu hirsute universe
       state: present
       update_cache: true

    - name: Upgrade Ansible
      apt:
        name: ansible
        state: latest

    - name: Make sure hirsute universe repository is removed again
      apt_repository:
       repo: deb http://archive.ubuntu.com/ubuntu hirsute universe
       state: absent
       update_cache: true

  roles:
    - role: geerlingguy.apache
      tags: apache
    - role: geerlingguy.php-versions
      tags: php
    - role: geerlingguy.php
      tags: php
    - role: geerlingguy.php-mysql
      tags: php
    - role: geerlingguy.mysql
      tags: mysql
    - role: geerlingguy.docker
      tags: docker
    - role: geerlingguy.postfix
      tags: postfix
    - role: geerlingguy.security
      tags: security
    - role: geerlingguy.firewall
      tags: firewall
    - role: geerlingguy.ntp
      tags: ntp

  tasks:
  
    - name: Remove standard index.html
      file:
        path: /var/www/html/index.html
        state: absent
      tags: php-post
      
    - name: Create Hello World PHP page
      copy:
        dest: /var/www/html/index.php
        content: "<?php echo 'Hello World!'; ?>"
      tags: php-post

    - name: Hush all the login banner stuff
      file:
        path: ~/.hushlogin
        state: touch
      become: false
      tags: hush

    - name: Install the extra packages
      apt:
        name: "{{ extra_packages }}"
        state: present
      tags: extra

    - name: Upgrade all packages
      apt:
        upgrade: dist
        update_cache: yes
      tags: apt

    - name: Autoclean apt
      apt:
        autoclean: yes
      tags: apt
        
    - name: Autoremove apt
      apt:
        autoremove: yes
      tags: apt

    - name: Check if a reboot is needed
      register: reboot_required_file
      stat:
        path: /var/run/reboot-required
        get_md5: no
      tags: post

  post_tasks:
    - name: Reboot warning if needed
      debug:
        msg: "Please reboot your system"
      when: reboot_required_file.stat.exists
      tags: post
